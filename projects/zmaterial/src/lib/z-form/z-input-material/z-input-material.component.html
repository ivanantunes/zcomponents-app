<div [formGroup]="form">

  <div [ngSwitch]="input.controlType">

    <!-- ? Input | Text - Password - IP - CPF - CNPJ - Plate - CPF/CNPJ -->
    <div *ngSwitchCase="'inputText'">

      <mat-form-field class="full-width" appearance="outline" [hintLabel]="input.hint">

        <mat-label>{{input.label}}</mat-label>

        <input matInput
        [placeholder]="input.label"
        [name]="input.key"
        [formControl]="input.currentControl"
        [readonly]="true"
        [maxlength]="asInputText.maxlength"
        [id]="input.key"
        [type]="asInputText.type"
        [mask]="asInputText.mask"
        [readonly]="input.readonly"
        [required]="input.required"
        [dropSpecialCharacters]="false">

        <mat-icon *ngIf="input.icon" matSuffix>{{input.icon}}</mat-icon>

        <mat-error class="error">
          <ng-container *ngTemplateOutlet="errorsTemplate"></ng-container>
        </mat-error>

        <mat-hint *ngIf="asInputText.maxlength" align="end">
          {{currentControl.value.length || 0}} / {{asInputText.maxlength}}
        </mat-hint>

      </mat-form-field>

    </div>

    <!-- ? Input | Select -->
    <div *ngSwitchCase="'inputSelect'">

      <mat-form-field class="full-width" appearance="outline" [hintLabel]="input.hint">

        <mat-label>{{ input.label }}</mat-label>
        <mat-icon matSuffix>{{input.icon ? input.icon : 'expand_more'}}</mat-icon>
        <input matInput type="text" #autoInput
        [required]="input.required"
        (focus)="focusChange($event.target)"
        [readonly]="!asInputSelect.typeWhileSerching && isLoading"
        [placeholder]="input.label"
        [formControl]="input.currentControl"
        [id]="input.key"
        [matAutocompleteDisabled]="!auto"
        [matAutocomplete]="auto"
        >

        <mat-autocomplete #auto="matAutocomplete" [displayWith]="selectDisplay.bind(this)">

          <mat-option [disabled]="true" *ngIf="isLoading" class="is-loading">
            <mat-spinner diameter="50"></mat-spinner>
          </mat-option>

          <ng-container *ngIf="getDataObs | async as results">

            <mat-option [disabled]="true" *ngIf="!isLoading && results.items.length === 0 && autoInput.value !== ''"
              class="is-loading">
              <span>Nenhum Resultado Econtrado</span>
            </mat-option>


            <ng-container *ngIf="!isLoading">
              <mat-option [hidden]="isLoading" *ngFor="let result of results.items"
                [value]="asInputSelect.valueProperty ? result[asInputSelect.valueProperty] : result">

                <ng-container *ngTemplateOutlet="asInputSelect.customOptionTemplate ? asInputSelect.customOptionTemplate : defaultMatOptionTemplate; context:{item: result}"></ng-container>

              </mat-option>
              <mat-option [disabled]="true" *ngIf="results.totalItems > asInputSelect.maxItems">
              <span>Resultado Não Completo. Refine sua Busca.</span>
            </mat-option>
            </ng-container>

          </ng-container>

        </mat-autocomplete>

        <mat-error>
          <ng-container *ngTemplateOutlet="errorsTemplate"></ng-container>
        </mat-error>

      </mat-form-field>

    </div>



  </div>


</div>

<ng-template #errorsTemplate>

  <div *ngIf="input.currentControl.errors && input.currentControl.invalid && (input.currentControl.dirty || input.currentControl.touched)">

    <div *ngFor="let error of getErrors(input.currentControl)">

      <div [ngSwitch]="error">

        <div *ngSwitchCase="'required'">
          {{input.label}} <strong>é obrigatório.</strong>
        </div>

        <div *ngSwitchCase="'email'">
          <strong>Não é um email válido.</strong>
        </div>

        <div *ngSwitchCase="'pattern'">
          <strong>Padrão inválido para</strong> {{input.label}}.
        </div>

        <div *ngSwitchCase="'minlength'">
          <strong>Valor muito curto para</strong> {{input.label}}.
        </div>

        <div *ngSwitchCase="'maxlength'">
          <strong>Valor muito longo para</strong> {{input.label}}.
        </div>

        <div *ngSwitchCase="'invalidCPF'">
          <strong>Valor não é um CPF válido.</strong>
        </div>

        <div *ngSwitchCase="'invalidCNPJ'">
          <strong>Valor não é um CNPJ válido.</strong>
        </div>

        <div *ngSwitchCase="'invalidOption'">
          <strong>Selecione uma das opções sugeridas.</strong>
        </div>

        <div *ngSwitchCase="'remoteError'">
          <strong>{{ input.currentControl.errors[error] }}</strong>
        </div>

        <div *ngSwitchDefault><strong>{{error}}</strong></div>
      </div>

    </div>


  </div>

</ng-template>

<ng-template #defaultMatOptionTemplate let-result='item'>
  <img *ngIf="asInputSelect.displayImageSelect" aria-hidden
    [src]="asInputSelect.displayImageSelect(result) || 'assets/no-profile.jpeg'" height="25">
  <span>{{ asInputSelect.firstDisplaySelect(result) }}</span>
  <small *ngIf="asInputSelect.secondaryDisplaySelect"> | {{ asInputSelect.secondaryDisplaySelect(result) }}</small>
</ng-template>
